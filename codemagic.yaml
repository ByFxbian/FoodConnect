workflows:
  ios-workflow:
    name: iOS Workflow
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: AppManagerKey
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: at.foodconnect
      vars:
        APP_ID: 6742403694 # <-- Deine App ID
      flutter: stable
      xcode: latest # Falls nötig, auf eine feste Version setzen, z.B. "15.0"
      cocoapods: default

    scripts:
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles

      - name: Fetch Flutter Dependencies
        script: |
          flutter clean
          flutter pub get
          flutter pub cache repair
          flutter gen-l10n || echo "No localization setup, skipping..."
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Ensure Runner.xcworkspace Exists
        script: |
          cd ios
          if [ ! -d "Runner.xcworkspace" ]; then
            echo "⚠️ Runner.xcworkspace fehlt! Erstelle es neu..."
            pod install --repo-update
          fi
          cd ..

      - name: Ensure Podfile Changes are Applied
        script: |
          cd ios
          if [ ! -f "Podfile.lock" ] || [ "$(git status --porcelain Podfile.lock | wc -l)" -ne 0 ]; then
            echo "⚠️ Podfile.lock fehlt oder wurde geändert, installiere Pods..."
            pod install --repo-update --clean-install
          fi
          cd ..

      - name: Fix Podfile Configuration
        script: |
          cd ios
          echo "🔧 Fixing Xcode config..."
          sed -i '' 's|Pods-Runner.release.xcconfig|Target Support Files/Pods-Runner/Pods-Runner.release.xcconfig|' Runner.xcodeproj/project.pbxproj
          sed -i '' 's|Pods-Runner.profile.xcconfig|Target Support Files/Pods-Runner/Pods-Runner.profile.xcconfig|' Runner.xcodeproj/project.pbxproj
          cd ..

      - name: Install Firebase CLI
        script: |
          npm install -g firebase-tools
          dart pub global activate flutterfire_cli

      - name: Verify cloud_firestore and GeneratedPluginRegistrant.m
        script: |
          flutter pub get
          export PATH="$PATH:$HOME/.pub-cache/bin"
          flutterfire configure --yes
          cd ios && pod install --repo-update && cd ..
          
          if ! grep -q "cloud_firestore" ios/Podfile; then
            echo "❌ cloud_firestore fehlt in Podfile! Versuche es zu fixen..."
            flutter pub get
            flutterfire configure --yes
            cd ios && pod install --repo-update && cd ..
          fi

          if [ ! -f "ios/Runner/GeneratedPluginRegistrant.m" ]; then
            echo "⚠️ GeneratedPluginRegistrant.m fehlt! Versuche es zu regenerieren..."
            flutter pub run build_runner build --delete-conflicting-outputs
            flutter pub get
          fi

      - name: Flutter analyze
        script: |
          flutter analyze

      - name: Flutter unit tests
        script: |
          flutter test
        ignore_failure: true

      - name: Pre build stuff
        script: |
          rm -rf ios
          flutter create .

      - name: Set iOS Deployment Target
        script: |
          perl -pi -e 's/# platform :ios, .*/platform :ios, "16.0"/' ios/Podfile

      - name: Print modified Podfile
        script: |
          echo "📜 Aktuelle Podfile nach Änderung:"
          cat ios/Podfile

      - name: Fix Bundle Identifier
        script: |
          echo "🔧 Fixing Bundle Identifier..."
          perl -pi -e 's/PRODUCT_BUNDLE_IDENTIFIER = at\.hfs\.foodconnect/PRODUCT_BUNDLE_IDENTIFIER = at.foodconnect/g' ios/Runner.xcodeproj/project.pbxproj
          cat ios/Runner.xcodeproj/project.pbxproj | grep PRODUCT_BUNDLE_IDENTIFIER

      - name: Enable Automatic Signing
        script: |
          echo "🔑 Enabling automatic signing..."
          perl -pi -e 's/ProvisioningStyle = Manual;/ProvisioningStyle = Automatic;/g' ios/Runner.xcodeproj/project.pbxproj

      - name: Set Development Team ID in Xcode
        script: |
          cd ios
          xcodebuild -project Runner.xcodeproj \
          -target Runner \
          -configuration Release \
          CODE_SIGN_IDENTITY="Apple Development" \
          DEVELOPMENT_TEAM=DW239Z4DYF \


      - name: Flutter build ipa and automatic versioning
        script: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "No generated files needed"
          flutter build ipa --release \
            --build-name=1.0.0 \
            --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 1)) \
            --export-options-plist=/Users/builder/export_options.plist \
            --codesign

          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportPath build/ios/ipa \
            -exportOptionsPlist /Users/builder/export_options.plist \
            -allowProvisioningUpdates

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log

    publishing:
      app_store_connect:
          auth: integration
          
          # Configuration related to TestFlight (optional)
          # Note: This action is performed during post-processing.
          submit_to_testflight: true
          beta_groups: 
            - Test1

          # Configuration related to App Store (optional)
          # Note: This action is performed during post-processing.
          submit_to_app_store: false  